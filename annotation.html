<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title></title>
        <script type="text/javascript" src="js/semantic-cluster.js"></script>
        <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
        <link rel="stylesheet" href="css/semantic-cluster.css" type="text/css">
    </head>
    
    <body>
        <div style="position: fixed; top: 5px">
            Select a topic:
            <select id = "topicSelect" onchange="topicSelection()">
                <option></option>
                <option value="09">9.Toyota Recall</option>
                <option value="22">22.healthcare law unconstitutional</option>
                <option value="23">23.Amtrak train service</option>
                <option value="36">36.Moscow airport bombing</option>
                <option value="55">55.berries and weight loss</option>
                <option value="75">75.Aguilera super bowl fail</option>
                <option value="79">79.Saleh Yemen overthrow</option>
                <option value="88">88.Kings' Speech awards</option>
                <option value="95">95.Facebook privacy</option>
                <option value="98">98.Australian floods</option>
            </select>&nbsp;&nbsp;&nbsp;&nbsp
            Jaccard threshold: <input type="text" id = "jaccardText" value = "0.5"/>
            <a href="#" class="button" id = "expand">Expand All Tweets</a>&nbsp;&nbsp
            <a href="#" class="button" id = "collapse">Collapse All Tweets</a>
        </div>
        <table id = "main" style="width: 100%; margin: auto; display: none;">
            <tr>
                <td id = "tweets" style = "width: 96%; word-break: break-all; white-space: normal; margin-left: 20px; margin-bottom: 20px; border: dotted 1px; position: fixed; top: 30px; background-color: white; z-index: 1">
                    <!--<h2>Instructions:</h2>
                    (1) Enter 0 then press Enter to create a new cluster.<br>
                    (2) Enter a number X other than 0 in the box then press Enter to put the tweet in the existing cluster X.<br>
                    (3) Press Space to take the suggestion.<br><br>-->
                    <table style="width: 100%">
                        <tr>
                            <td style="vertical-align: bottom">
                                <input type="button" value="Create a new cluster" id = "newClusterBtn" onclick="createCluster()"/>
                            </td>
                            <td style="width: 95%">
                                <b>New tweet:</b><br>
                                <div id = "presentTweet" style="border: solid 1px; background-color:#CCFFFF"></div>
                            </td>
                        </tr>
                        <tr>
                            <td style="vertical-align: bottom; text-align: center">
                                <input type="button" value="Take suggestion" id = "suggestionBtn" onclick="takeSuggestion()"/>
                            </td>
                            <td style="vertical-align: bottom">
                                <div id = "suggestionDiv"></div>
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: center">
                                <!--Put in cluster: <input type="text" id = "clusterSelection" placeholder="enter a number..."/>
                                <input type="button" id="submitbtn" onclick="putintoCluster()" style="display: none"/><br><br>-->
                                <div><input type="button" id = "undoBtn" value="Undo" onclick="undo()"/></div>
                            </td>
                            <td>
                                <label id = "remainingTweets"></label>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td id = "clusters" style="word-break: break-all; white-space: normal; padding-top: 150px; padding-left: 60px;">
                </td>
            </tr>
        </table>
        <input type="button" id = "storeBtn" value="Store clustering results in file" style="display: none" onclick="storeResults()"/>
        <div id="results"></div>
        
        <script type="text/javascript">
            var tweetids = [];
            var tweettext = [];
            var clustersids = [];
            var clusterstext = [];
            var length;
            var current = 0;
            var remaining;
            var undoclusteridsi = [];
            var undoclusteridsj = [];
            
            function setJaccard() {
                threshold = document.getElementById("jaccardText").value;
            }
            function topicSelection() {
                tweetids = [];
                tweettext = [];
                clustersids = [];
                clusterstext = [];
                current = 0;
                choices = document.getElementById("topicSelect");
                topicNum = choices[choices.selectedIndex].value;
                document.getElementById("main").style.display = "";
                $.ajax({
                    url: "data/relevant-chrono-sort-tweets/json/tweet_topic" + topicNum + ".json",
                    dataType: "text",
                    async: false,
                    success: function(json) {
                        var data = $.parseJSON(json);
                        length = data.tweets.length;
                        remaining = length - 1;
                        for (var i = 0, tweet; i < data.tweets.length; i++) {
                            tweet = data.tweets[i];
                            tweetids.push(tweet.id);
                            tweettext.push(tweet.text);
                        }
                    }
                });
                $("#presentTweet").html(tweettext[current]);
                $("#remainingTweets").html("Remaining tweets: " + remaining);
                $("#clusters").html("");
                document.getElementById("clusters").style.paddingTop = 150;
                document.getElementById("tweets").style.display = "";
                document.getElementById("storeBtn").style.display = "none";
                //document.getElementById("suggestionBtn").style.display = "none";
                //document.getElementById("suggestionDiv").style.display = "none";
                
                $("#suggestionDiv").html("<b>Suggestion: Create a new cluster.</b><br>");
                document.getElementById("undoBtn").disabled = true;
                $("#results").html("");
            }
            
            var suggestionNum = 0;
            document.getElementById("suggestionBtn").addEventListener("click", convertTrees, false);
            function takeSuggestion() {
                if ($("#suggestionDiv").text() == "Suggestion: Create a new cluster.") {
                    createCluster();
                    
                } else{
                    var j = clustersids[suggestionNum].length;
                    clustersids[suggestionNum].push(tweetids[current]);
                    clusterstext[suggestionNum].push(tweettext[current]);
                    undoclusteridsi.push(suggestionNum);
                    undoclusteridsj.push(j);
                    displayClusters();
                    displayNextTweet();
                }
            }
            
            document.getElementById("newClusterBtn").addEventListener("click", convertTrees, false);
            function createCluster() {
                document.getElementById("undoBtn").disabled = false;
                var j = 0;
                if (clustersids.length == 0) {
                    document.getElementById("suggestionBtn").style.display = "";
                } else {
                    j = clustersids[clustersids.length - 1].length - 1;
                }
                var clusterid = [];
                var clustertext = [];
                clusterid.push(tweetids[current]);
                clustertext.push(tweettext[current]);
                clustersids.push(clusterid);
                clusterstext.push(clustertext);
                undoclusteridsi.push(clustersids.length - 1);
                undoclusteridsj.push(j);
                displayClusters();
                displayNextTweet();
            }
            

            function addtoCluster(clusterNum) {
                var j = clustersids[clusterNum].length;
                clustersids[clusterNum].push(tweetids[current]);
                clusterstext[clusterNum].push(tweettext[current]);
                undoclusteridsi.push(clusterNum);
                undoclusteridsj.push(j);
                displayClusters();
                displayNextTweet();
            }
            
            var maxSimi = 0;
            function displayClusters() {
                var items = [];
                items.push("<ul class='mktree' id = 'tree0'>");
                maxSimi = 0;
                for (var i = 0; i < clustersids.length; i ++) {
                    //compare representatives with the current tweet, set the transparency and record the most similar one.
                    var opacity = 1;
                    if (remaining > 0) {
                        var similarity = jaccard(clusterstext[i][0], tweettext[current + 1]);
                        if (similarity > maxSimi) {
                            maxSimi = similarity;
                            suggestionNum = i;
                        }
                        opacity = 0.4 + similarity * 0.6;
                    }
                    items.push("<br><input type = 'button' id = 'addtoClusterBtn" + i + "' style = 'margin-right: 32px' value = 'Add' onclick='addtoCluster(" + i + ")'/>");
                    items.push("<li id = 'cluster" + i + "' style='border: solid 1px; background-color: #FFCC99; display: inline-block; opacity: " + opacity + "'>");
                    items.push(clusterstext[i][0]);
                    for (var j = 1; j < clustersids[i].length; j ++) {
                        items.push("<ul><li>" + clusterstext[i][j] + "</li><br></ul>");
                    }
                    items.push("</li>");
                }
                items.push("</ul>");
                $("#clusters").html(items.join(""));
                for (var i = 0; i < clustersids.length; i ++) {
                    document.getElementById("addtoClusterBtn" + i).addEventListener("click", convertTrees, false);
                }
            }
            
            function displayNextTweet() {
                var threshold = $("#jaccardText").val();
                if (remaining > 0) {
                    current = current + 1;
                    remaining = remaining - 1;
                    $("#remainingTweets").html("Remaining tweets: " + remaining);
                    $("#presentTweet").html(tweettext[current]);
                    if (clustersids.length > 0) {
                        document.getElementById("suggestionDiv").style.display = "";
                        if (maxSimi > threshold) {
                            $("#suggestionDiv").html("<b>Suggestion:</b><br>" + "<div style='border: solid 1px; background-color:#CCFFCC'>" + clusterstext[suggestionNum][0] + "</div>");
                            $("#cluster" + suggestionNum).css("background-color", "#CCFFCC");
                        } else {
                            $("#suggestionDiv").html("<b>Suggestion: Create a new cluster.</b><br>");
                        }  
                    }   
                } else {
                    alert("You're done. Great job!");
                    document.getElementById("clusters").style.paddingTop = 30;
                    document.getElementById("tweets").style.display = "none";
                    for (var i = 0; i < clustersids.length; i ++) {
                        document.getElementById("addtoClusterBtn" + i).style.display = "none";
                    }
                    document.getElementById("storeBtn").style.display = "";
                }
            }
            
            document.getElementById("undoBtn").addEventListener("click", convertTrees, false);
            function undo() {
                if (undoclusteridsi.length > 0) {
                    current = current - 2;
                    remaining = remaining + 2;
                    var i = undoclusteridsi.pop();
                    var j = undoclusteridsj.pop();
                    if (j === 0) {
                        clustersids.pop();
                        clusterstext.pop();
                    } else {
                        newclusterids = [];
                        newclustertext = [];
                        for (var index = 0; index < j; index ++) {
                            newclusterids.push(clustersids[i][j]);
                            newclustertext.push(clusterstext[i][j]);
                        }
                        clustersids[i] = newclusterids;
                        clusterstext[i] = newclustertext;
                    }
                    displayClusters();
                    displayNextTweet();
                    if (current === 0) {
                        //document.getElementById("suggestionDiv").style.display = "none";
                        //document.getElementById("suggestionBtn").style.display = "none";
                        $("#suggestionDiv").html("<b>Suggestion: Create a new cluster.</b><br>");
                        document.getElementById("undoBtn").disabled = true;
                    }
                } else {
                    alert("no more undos");
                }
            }
            
            function storeResults() {
                $("#results").html(JSON.stringify(clustersids));
            }
            
            function jaccard(t1, t2) {
                t1 = t1.toLowerCase().split(" ");
                t2 = t2.toLowerCase().split(" ");
                var vocab1 = refineTweet(t1);
                var vocab2 = refineTweet(t2);
                var andCount = 0;
                for (var key in vocab2) {
                    if (key in vocab1) {
                        andCount = andCount + 1;
                    }
                }
                var orCount = Object.keys(vocab1).length + Object.keys(vocab2).length - andCount;
                return andCount * 1.0 / orCount;
            }
            
            function refineTweet(t) {
                var vocab = {};
                for (var i = 0; i < t.length; i ++) {
                    if (t[i] !== "rt" && t[i].substring(0, 4) !== "http" && t[i][0] !== "@") {
                        if (t[i][0] === "#") {
                            t[i] = t[i].substring(1, t[i].length);
                        }
                        if (t[i].substring(t[i].length - 3, t[i].length) === "...") {
                            t[i] = t[i].substring(0, t[i].length - 3);
                        }
                        vocab[t[i]] = true;
                    }
                }
                return vocab;
            }
            
            $("#expand").click(function() {expandTree('tree0'); return false;});
            $("#collapse").click(function() {collapseTree('tree0'); return false;});
            
            //$('#jaccardText').keypress(function(e){
            //    if(e.keyCode == 13)
            //        $('#submitbtn').click();
            //});
        </script>
    </body>
</html>